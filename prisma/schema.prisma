generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Role {
  id    Int    @id @default(autoincrement())
  name  String @unique
  users User[]
}

model User {
  id                            Int                      @id @default(autoincrement())
  username                      String                   @unique
  password                      String
  createdAt                     DateTime                 @default(now())
  updatedAt                     DateTime                 @updatedAt
  foto                          String?
  namaLengkap                   String
  noTlp                         String?
  roleId                        Int
  passCode                      String?
  alamat                        String?
  email                         String?
  Absensi                       Absensi[]
  logs                          AuditLog[]
  forgotPasscodes               ForgotPasscode[]
  guruPermissions               GuruPermission[]         @relation("GuruPermissions")
  Hafalan                       Hafalan[]
  guruHalaqah                   Halaqah[]
  HalaqahSantri                 HalaqahSantri[]
  createdJenisUjian             JenisUjian[]             @relation("CreatedJenisUjian")
  createdKomponenPenilaianJenis KomponenPenilaianJenis[] @relation("CreatedKomponenPenilaianJenis")
  notif                         Notifikasi[]
  sebagaiOrangTua               OrangTuaSantri[]         @relation("OrangTua")
  anak                          OrangTuaSantri[]         @relation("Santri")
  pengumumanDibuat              Pengumuman[]
  pengumumanDibaca              PengumumanRead[]
  Prestasi                      Prestasi[]
  createdRaport                 RaportSantri[]           @relation("CreatedRaport")
  raportSantri                  RaportSantri[]           @relation("RaportSantri")
  createdTahunAjaran            TahunAjaran[]
  TargetHafalan                 TargetHafalan[]
  createdTemplateRaport         TemplateRaport[]
  createdTemplateUjian          TemplateUjian[]
  Ujian                         Ujian[]
  ujianGuruGuru                 UjianGuru[]              @relation("UjianGuruGuru")
  ujianGuruSantri               UjianGuru[]              @relation("UjianGuruSantri")
  createdUjian                  UjianSantri[]            @relation("CreatedUjian")
  verifiedUjian                 UjianSantri[]            @relation("VerifiedUjian")
  ujianSantri                   UjianSantri[]            @relation("UjianSantri")
  role                          Role                     @relation(fields: [roleId], references: [id])
}

model Halaqah {
  id          Int              @id @default(autoincrement())
  namaHalaqah String
  guruId      Int?
  permissions GuruPermission[] @relation("HalaqahPermissions")
  guru        User?            @relation(fields: [guruId], references: [id])
  santri      HalaqahSantri[]
  jadwal      Jadwal[]
  ujian       Ujian[]
}

model HalaqahSantri {
  id            Int      @id @default(autoincrement())
  tahunAkademik String
  semester      Semester
  halaqahId     Int
  santriId      Int
  halaqah       Halaqah  @relation(fields: [halaqahId], references: [id], onDelete: Cascade)
  santri        User     @relation(fields: [santriId], references: [id], onDelete: Cascade)
}

model Hafalan {
  id          Int           @id @default(autoincrement())
  tanggal     DateTime
  surat       String
  ayatMulai   Int
  ayatSelesai Int
  status      StatusHafalan
  keterangan  String?
  santriId    Int
  santri      User          @relation(fields: [santriId], references: [id], onDelete: Cascade)
}

model TargetHafalan {
  id         Int          @id @default(autoincrement())
  surat      String
  ayatTarget Int
  deadline   DateTime
  status     StatusTarget
  santriId   Int
  santri     User         @relation(fields: [santriId], references: [id], onDelete: Cascade)
}

model Jadwal {
  id             Int       @id @default(autoincrement())
  hari           Hari
  jamMulai       DateTime
  jamSelesai     DateTime
  halaqahId      Int
  isTemplate     Boolean   @default(true)
  tanggalMulai   DateTime?
  tanggalSelesai DateTime?
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @default(now()) @updatedAt
  absensi        Absensi[]
  halaqah        Halaqah   @relation(fields: [halaqahId], references: [id])
}

model Absensi {
  id       Int           @id @default(autoincrement())
  status   StatusAbsensi
  tanggal  DateTime
  santriId Int
  jadwalId Int
  jadwal   Jadwal        @relation(fields: [jadwalId], references: [id], onDelete: Cascade)
  santri   User          @relation(fields: [santriId], references: [id], onDelete: Cascade)
}

model Prestasi {
  id           Int     @id @default(autoincrement())
  namaPrestasi String
  keterangan   String?
  kategori     String?
  tahun        Int
  santriId     Int
  validated    Boolean @default(false)
  santri       User    @relation(fields: [santriId], references: [id], onDelete: Cascade)
}

model Raport {
  id            Int            @id @default(autoincrement())
  semester      Semester
  tahunAkademik String
  validated     Boolean        @default(false)
  details       RaportDetail[]
  ujian         Ujian[]
}

model RaportDetail {
  id           Int      @id @default(autoincrement())
  nilaiAkhir   Float
  catatan      String?
  tanggalCetak DateTime
  raportId     Int
  raport       Raport   @relation(fields: [raportId], references: [id])
}

model Ujian {
  id         Int            @id @default(autoincrement())
  jenis      JenisUjianEnum
  nilai      Float
  tanggal    DateTime
  keterangan String?
  santriId   Int
  halaqahId  Int
  raportId   Int
  halaqah    Halaqah        @relation(fields: [halaqahId], references: [id])
  raport     Raport         @relation(fields: [raportId], references: [id])
  santri     User           @relation(fields: [santriId], references: [id], onDelete: Cascade)
}

model UjianGuru {
  id           Int      @id @default(autoincrement())
  santriId     Int
  guruId       Int
  jenisUjian   String
  juzMulai     Int
  juzSelesai   Int
  totalNilai   Float
  keterangan   String?
  tanggalUjian DateTime @default(now())
  status       String   @default("SELESAI")
  pengaturan   String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  guru         User     @relation("UjianGuruGuru", fields: [guruId], references: [id], onDelete: Cascade)
  santri       User     @relation("UjianGuruSantri", fields: [santriId], references: [id], onDelete: Cascade)
}

model Notifikasi {
  id      Int       @id @default(autoincrement())
  pesan   String
  tanggal DateTime  @default(now())
  type    NotifType
  refId   Int?
  userId  Int
  user    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Grafik {
  id         Int     @id @default(autoincrement())
  tipeGrafik String
  periode    String
  dataJson   Json
  refId      Int?
  refType    RefType
}

model Backup {
  id            Int      @id @default(autoincrement())
  namaFile      String
  tanggalBackup DateTime @default(now())
}

model AuditLog {
  id         Int      @id @default(autoincrement())
  action     String
  keterangan String?
  tanggal    DateTime @default(now())
  userId     Int
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ForgotPasscode {
  id           Int       @id @default(autoincrement())
  phoneNumber  String
  message      String?
  isRead       Boolean   @default(false)
  isRegistered Boolean   @default(false)
  userId       Int?
  createdAt    DateTime  @default(now())
  readAt       DateTime?
  user         User?     @relation(fields: [userId], references: [id])
}

model AdminSettings {
  id                          Int      @id @default(autoincrement())
  whatsappNumber              String   @default("+6281213923253")
  whatsappMessageHelp         String   @default("Assalamualaikum App Ar-Hafalan. saya mau nanya tentang App : \n\nterimakasih Atas bantuannya")
  whatsappMessageRegistered   String   @default("Assalamualaikum Warahmatullahi Wabarakatuh,\n\nSaya super-admin dari Aplikasi AR-Hafalan. Berikut adalah passcode yang Anda minta:\n\nüìÖ Tanggal Permintaan: {tanggal}\nüë§ Nama Pengguna: {nama}\nüîê Passcode: {passcode}\n\nPasscode ini dapat digunakan untuk mengakses akun Anda di Aplikasi AR-Hafalan. Jaga kerahasiaan passcode Anda dan jangan berikan kepada siapapun.\n\nTerima kasih atas partisipasinya dalam menggunakan Aplikasi AR-Hafalan.\n\nWassalamualaikum Warahmatullahi Wabarakatuh.")
  whatsappMessageUnregistered String   @default("Assalamualaikum Warahmatullahi Wabarakatuh,\n\nSaya super-admin dari Aplikasi AR-Hafalan. Maaf, nomor {nomor} belum terdaftar dalam sistem kami.\n\nSilakan melakukan pendaftaran terlebih dahulu melalui aplikasi atau hubungi admin untuk informasi lebih lanjut.\n\nTerima kasih.\n\nWassalamualaikum Warahmatullahi Wabarakatuh.")
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt
}

model Pengumuman {
  id                Int              @id @default(autoincrement())
  judul             String
  isi               String
  tanggal           DateTime         @default(now())
  createdAt         DateTime         @default(now())
  createdBy         Int?
  tanggalKadaluarsa DateTime?
  targetAudience    TargetAudience   @default(semua)
  updatedAt         DateTime         @updatedAt
  creator           User?            @relation(fields: [createdBy], references: [id])
  dibacaOleh        PengumumanRead[]
}

model PengumumanRead {
  id           Int        @id @default(autoincrement())
  pengumumanId Int
  userId       Int
  dibacaPada   DateTime   @default(now())
  pengumuman   Pengumuman @relation(fields: [pengumumanId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([pengumumanId, userId])
}

model OrangTuaSantri {
  id         Int      @id @default(autoincrement())
  orangTuaId Int
  santriId   Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  orangTua   User     @relation("OrangTua", fields: [orangTuaId], references: [id], onDelete: Cascade)
  santri     User     @relation("Santri", fields: [santriId], references: [id], onDelete: Cascade)

  @@unique([orangTuaId, santriId])
  @@index([orangTuaId])
  @@index([santriId])
}

model GuruPermission {
  id         Int      @id @default(autoincrement())
  guruId     Int
  halaqahId  Int
  canAbsensi Boolean  @default(true)
  canHafalan Boolean  @default(false)
  canTarget  Boolean  @default(false)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  createdBy  Int?
  guru       User     @relation("GuruPermissions", fields: [guruId], references: [id], onDelete: Cascade)
  halaqah    Halaqah  @relation("HalaqahPermissions", fields: [halaqahId], references: [id], onDelete: Cascade)

  @@unique([guruId, halaqahId])
}

model TahunAjaran {
  id             Int              @id @default(autoincrement())
  tahunMulai     Int
  tahunSelesai   Int
  semester       Semester
  namaLengkap    String
  tanggalMulai   DateTime
  tanggalSelesai DateTime
  isActive       Boolean          @default(false)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  createdBy      Int?
  raportSantri   RaportSantri[]
  creator        User?            @relation(fields: [createdBy], references: [id])
  templateRaport TemplateRaport[]
  templateUjian  TemplateUjian[]
  ujianSantri    UjianSantri[]

  @@unique([tahunMulai, tahunSelesai, semester])
}

model TemplateUjian {
  id                Int                 @id @default(autoincrement())
  namaTemplate      String
  jenisUjian        JenisUjianTemplate
  deskripsi         String?
  status            StatusTemplate      @default(aktif)
  tahunAjaranId     Int
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  createdBy         Int?
  komponenPenilaian KomponenPenilaian[]
  creator           User?               @relation(fields: [createdBy], references: [id])
  tahunAjaran       TahunAjaran         @relation(fields: [tahunAjaranId], references: [id], onDelete: Cascade)
  ujianSantri       UjianSantri[]
}

model JenisUjian {
  id                Int                      @id @default(autoincrement())
  nama              String
  kode              String                   @unique
  deskripsi         String?
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt
  createdBy         Int?
  creator           User?                    @relation("CreatedJenisUjian", fields: [createdBy], references: [id])
  komponenPenilaian KomponenPenilaianJenis[]
}

model KomponenPenilaianJenis {
  id           Int        @id @default(autoincrement())
  jenisUjianId Int
  nama         String
  bobot        Float
  deskripsi    String?
  urutan       Int        @default(1)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  createdBy    Int?
  creator      User?      @relation("CreatedKomponenPenilaianJenis", fields: [createdBy], references: [id])
  jenisUjian   JenisUjian @relation(fields: [jenisUjianId], references: [id], onDelete: Cascade)
}

model KomponenPenilaian {
  id              Int           @id @default(autoincrement())
  templateUjianId Int
  namaKomponen    String
  bobotNilai      Float
  nilaiMaksimal   Float         @default(100.0)
  nilaiMinimal    Float         @default(0.0)
  deskripsi       String?
  urutan          Int           @default(1)
  isActive        Boolean       @default(true)
  templateUjian   TemplateUjian @relation(fields: [templateUjianId], references: [id], onDelete: Cascade)
  nilaiUjian      NilaiUjian[]
}

model TemplateRaport {
  id                Int            @id @default(autoincrement())
  namaTemplate      String
  logoLembaga       String?
  namaLembaga       String
  alamatLembaga     String?
  headerKop         String?
  footerKop         String?
  tandaTanganKepala String?
  namaKepala        String?
  jabatanKepala     String?
  formatTabel       Json?
  tampilanGrafik    Boolean        @default(true)
  tampilanRanking   Boolean        @default(true)
  catatanTemplate   String?
  tahunAjaranId     Int
  status            StatusTemplate @default(aktif)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  createdBy         Int?
  raportSantri      RaportSantri[]
  creator           User?          @relation(fields: [createdBy], references: [id])
  tahunAjaran       TahunAjaran    @relation(fields: [tahunAjaranId], references: [id], onDelete: Cascade)
}

model UjianSantri {
  id                Int           @id @default(autoincrement())
  santriId          Int
  templateUjianId   Int
  tahunAjaranId     Int
  tanggalUjian      DateTime
  nilaiAkhir        Float?
  statusUjian       StatusUjian   @default(draft)
  catatanGuru       String?
  juzDari           Int?
  juzSampai         Int?
  diverifikasiBy    Int?
  tanggalVerifikasi DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  createdBy         Int?
  nilaiUjian        NilaiUjian[]
  creator           User?         @relation("CreatedUjian", fields: [createdBy], references: [id])
  verifikator       User?         @relation("VerifiedUjian", fields: [diverifikasiBy], references: [id])
  santri            User          @relation("UjianSantri", fields: [santriId], references: [id], onDelete: Cascade)
  tahunAjaran       TahunAjaran   @relation(fields: [tahunAjaranId], references: [id], onDelete: Cascade)
  templateUjian     TemplateUjian @relation(fields: [templateUjianId], references: [id], onDelete: Cascade)
}

model NilaiUjian {
  id                  Int                @id @default(autoincrement())
  ujianSantriId       Int
  komponenPenilaianId Int?
  nilaiRaw            Float
  nilaiTerbobot       Float
  catatan             String?
  urutan              Int?
  komponenPenilaian   KomponenPenilaian? @relation(fields: [komponenPenilaianId], references: [id], onDelete: Cascade)
  ujianSantri         UjianSantri        @relation(fields: [ujianSantriId], references: [id], onDelete: Cascade)
}

model RaportSantri {
  id               Int            @id @default(autoincrement())
  santriId         Int
  templateRaportId Int
  tahunAjaranId    Int
  nilaiRataRata    Float?
  totalNilaiAkhir  Float?
  ranking          Int?
  statusKelulusan  String?
  catatanGuru      String?
  grafikData       Json?
  tanggalGenerate  DateTime       @default(now())
  pathFilePDF      String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  createdBy        Int?
  creator          User?          @relation("CreatedRaport", fields: [createdBy], references: [id])
  santri           User           @relation("RaportSantri", fields: [santriId], references: [id], onDelete: Cascade)
  tahunAjaran      TahunAjaran    @relation(fields: [tahunAjaranId], references: [id], onDelete: Cascade)
  templateRaport   TemplateRaport @relation(fields: [templateRaportId], references: [id], onDelete: Cascade)

  @@unique([santriId, tahunAjaranId])
}

enum Semester {
  S1
  S2
}

enum StatusHafalan {
  ziyadah
  murojaah
}

enum StatusTarget {
  belum
  proses
  selesai
}

enum Hari {
  Senin
  Selasa
  Rabu
  Kamis
  Jumat
  Sabtu
  Minggu
}

enum StatusAbsensi {
  alpha
  izin
  masuk
}

enum JenisUjianEnum {
  tahfidz
  tasmi
  lainnya
}

enum NotifType {
  user
  hafalan
  rapot
  absensi
  pengumuman
}

enum RefType {
  guru
  halaqah
  santri
}

enum TargetAudience {
  semua
  guru
  santri
  ortu
  admin
  yayasan
  super_admin
}

enum JenisUjianTemplate {
  tasmi
  mhq
  uas
  kenaikan_juz
  tahfidz
  ujian_harian
  ujian_tengah_semester
}

enum StatusTemplate {
  aktif
  nonaktif
  draft
}

enum StatusUjian {
  draft
  selesai
  diverifikasi
  ditolak
}
